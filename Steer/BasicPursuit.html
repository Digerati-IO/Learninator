<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Basic Pursuit</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css"/>
    <script src="js/box2d.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.min.js"></script>
    <script src="../js/lib/external/steer.js"></script>
    <script src="js/controlHelper.js"></script>
</head>
<body onload="initScene();">

<div id="mainView" style=" height:660px; margin-top: -330px;">
    <div id="divScreen" style="border-radius:4px;"></div>
    <div id="steerLogo"></div>
</div>

<script type="text/javascript">

    var mousePt = {x: 0, y: 0};
    function mouseMoveCall(e) {
        mouseUpdate(e);
    }
    document.addEventListener("mousedown", function (e) {
        mouseUpdate(e);
        document.addEventListener("mousemove", mouseMoveCall);
    });
    document.addEventListener("mouseup", function (e) {
        document.removeEventListener("mousemove", mouseMoveCall);
    });
    document.addEventListener("touchstart", mouseUpdate);
    document.addEventListener("touchmove", mouseUpdate);
    function mouseUpdate(e) {
        if (e.changedTouches) {
            mousePt.x = (e.changedTouches[0].clientX - document.getElementById("mainView").offsetLeft) / 30;
            mousePt.y = (e.changedTouches[0].clientY - document.getElementById("mainView").offsetTop) / 30;
        } else if (e.pageX) {
            mousePt.x = (e.pageX - document.getElementById("mainView").offsetLeft) / 30;
            mousePt.y = (e.pageY - document.getElementById("mainView").offsetTop) / 30;
        }
        e.preventDefault();
    }

    function initScene() {
        var pixiRenderer = PIXI.autoDetectRenderer(1024, 660, {antialias: true, transparent: true, resolution: 1});
        document.getElementById("divScreen").appendChild(pixiRenderer.view);
        var pixiStage = new PIXI.Stage(0xFFFFFF, false);
        var domain = new steer.Domain();
        domain.createB2World(new box2d.b2Vec2(0, 0));
        var pixiDR = new steer.render.PixiDebugRenderer(domain, pixiStage, pixiRenderer, 900, 700);

        domain.addRenderer(pixiDR);
        steer.item.Creator.setDomainReference(domain);
        steer.item.Creator.pixelCreateFormat = true;

        var createInfo = {
            x: 200,
            y: 200,
            radius: 15,
            maxForce: 5,
            maxSpeed: 20,
            dynamic: true,
            canCollide: false
        };
        var mouseUnit = steer.item.Creator.createUnit(createInfo);
        var seekUnit = steer.item.Creator.createUnit({
            x: 100,
            y: 100,
            radius: 10,
            maxForce: 0.5,
            maxSpeed: 5,
            dynamic: true,
            canCollide: false
        });
        var pursuitUnit = steer.item.Creator.createUnit({
            x: 80,
            y: 80,
            radius: 10,
            maxForce: 0.5,
            maxSpeed: 5,
            dynamic: true,
            canCollide: false
        });

        var ddinfo = steer.render.DebugDrawInfo.create(mouseUnit);
        ddinfo.drawMask = steer.render.DebugDrawInfo.UNIT_RAYCAST;
        ddinfo.color = 0xFF6666;
        ddinfo = steer.render.DebugDrawInfo.create(seekUnit);
        ddinfo.drawMask = steer.render.DebugDrawInfo.UNIT_RAYCAST;
        ddinfo.color = 0x6666FF;
        ddinfo = steer.render.DebugDrawInfo.create(pursuitUnit);
        ddinfo.drawMask = steer.render.DebugDrawInfo.UNIT_RAYCAST;
        ddinfo.color = 0x66FF66;

        var myTimer = new steer.SteerTimer(30);

        myTimer.addEvent(steer.Event.LOGIC_UPDATE, function (e) {
            var delta = e.values.delta;

            domain.preUpdate();

            var arrivalForce = steer.controls.Behavior.arrival(mouseUnit, mousePt);
            mouseUnit.applyForce(arrivalForce);

            seekForce = steer.controls.Behavior.seek(seekUnit, mouseUnit.getb2Position());
            seekUnit.applyForce(seekForce);

            var pursuitForce = steer.controls.Behavior.pursuit(pursuitUnit, mouseUnit);
            pursuitUnit.applyForce(pursuitForce);

            domain.update(delta);
            pixiDR.integrate(0);

            pixiDR.guideGraphic.clear();
            var offset = steer.Vector.sub(mouseUnit.getb2Position(), pursuitUnit.getb2Position());
            var distanceDelta = offset.mag() / mouseUnit.maxSpeed;
            var targetVelAvg = mouseUnit.averageVelocity().mult(distanceDelta);
            var futureAt = mouseUnit.getb2Position().add(targetVelAvg);
            pixiDR.drawDot(futureAt, 0x99CC99, 0.1, 0.5);
            pixiDR.drawSegment(pursuitUnit.getb2Position(), futureAt, 0x99CC99, 0.03, 0.5);
            //seek unit
            pixiDR.drawDot(mouseUnit.getb2Position(), 0x6666FF, 0.1, 0.5);
            pixiDR.drawSegment(seekUnit.getb2Position(), mouseUnit.getb2Position(), 0x6666FF, 0.03, 0.5);
            pixiDR.drawDot(mousePt, 0x99CC99, 1, 0.5);
        });

        myTimer.addEvent(steer.Event.RENDER_UPDATE, function (e) {
            domain.integrate(e.values.delta);
        });

        myTimer.start();
    }
</script>
</body>
</html>
