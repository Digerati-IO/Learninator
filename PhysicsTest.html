<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Physics Test</title>

    <script src="js/lib/Vec.js"></script>
    <script src="js/lib/physics/Physics.js"></script>
</head>
<body>
<canvas></canvas>
<script>
    (function () {
        var ctx, mouseX, mouseY, trackRect, numRects = 2,
                PI = Math.PI,
                halfPI = Math.PI / 2,
                pi2 = PI * 2,
                rad = 0.0174532925199, // Math.PI/180
                rects = [],
                _mark = 0;

        Phys.worldWidth = 400;
        Phys.worldHeight = 300;

        // APP MANAGEMENT
        var _drawVec = new Vec();

        function tick() {
            ctx.clearRect(0, 0, Phys.worldWidth, Phys.worldHeight);

            var now = Date.now(),
                dt = now - _mark;

            _mark = now;
            Phys.elapsed = dt * 0.001;
            // console.log(Phys.elapsed);
            var i, j, a, b;
            for (i = 0; i < numRects; ++i) {
                rects[i].update();
            }

            var m;
            for (i = 0; i < (numRects - 1); ++i) {
                a = rects[i];

                for (j = i + 1; j < numRects; ++j) {
                    b = rects[j];

                    m = Phys.overlapAABB(a, b);
                    if (m) {
                        Phys.resolveCollision(a, b, m);
                    }
                }
            }

            for (i = 0; i < numRects; ++i) {
                rects[i].draw();
            }

            window.webkitRequestAnimationFrame(tick);
        }

        function mouseMove(evt) {
            trackRect.x = evt.clientX - mouseX;
            trackRect.y = evt.clientY - mouseY;
        }

        // INITIALIZE
        var canvas = document.getElementsByTagName('canvas')[0];
        canvas.width = Phys.worldWidth;//window.innerWidth;
        canvas.height = Phys.worldHeight;//window.innerHeight;
        Phys.ctx = ctx = canvas.getContext('2d');

        var i, r,
                a = 0, ao = pi2 / numRects,
                wx = Phys.worldWidth / 2,
                wy = Phys.worldHeight / 2;

        for (i = 0; i < numRects; i++) {
            r = new Phys.AABB(Math.cos(a) * 100 + wx,
                    Math.sin(a) * 100 + wy,
                    {});
            a += ao;
            rects[i] = r;
        }

        document.addEventListener('mousedown', function (evt) {
            trackRect = null;
            mouseX = evt.clientX;
            mouseY = evt.clientY;
            for (i = 0; i < numRects; i++) {
                r = rects[i];
                if (mouseX < r.min.x || mouseX > r.max.x) continue;
                if (mouseY < r.min.y || mouseY > r.max.y) continue;
                trackRect = r;
                break;
            }
            if (trackRect) {
                mouseX -= trackRect.x;
                mouseY -= trackRect.y;
                document.addEventListener('mousemove', mouseMove, false);
            }
        }, false);

        document.addEventListener('mouseup', function (evt) {
            if (trackRect) {
                document.removeEventListener('mousemove', mouseMove);
            }
        }, false);

        mouseX = wx;
        mouseY = wy;

        _mark = Date.now();
        tick();

    }());
</script>
</body>
</html>